## 目标
你自己可以随时把当前这套“局域网可访问”的启动方式停掉并重新启动（SurrealDB:8001 + API:5055 + Worker + Frontend:3000）。

## 重要注意
- 你机器如果开了代理环境变量（ALL_PROXY/HTTP_PROXY 等），SurrealDB/Worker/迁移可能会报 `python-socks is required to use a SOCKS proxy`。重启时要先清理代理变量。
- 你当前 `docker.env` 里包含真实密钥/Token，重启不需要改它，但建议后续做密钥轮换与避免泄露。

## 停止（3 种方式任选其一）
### 方式 A：在各自终端里 Ctrl+C（最干净）
- 终端 A：前端（next dev）
- 终端 B：API（uv run run_api.py）
- 终端 C：worker（surreal-commands-worker）
- 终端 D：SurrealDB（surreal start ...8001）

### 方式 B：用 pkill 一次性停（更快）
- `pkill -f "next dev"`
- `pkill -f "uv run run_api.py"`
- `pkill -f "surreal-commands-worker"`
- `pkill -f "surreal start"`

### 方式 C：确认端口占用后再 kill（最稳）
- `lsof -nP -iTCP:3000 -sTCP:LISTEN`
- `lsof -nP -iTCP:5055 -sTCP:LISTEN`
- `lsof -nP -iTCP:8001 -sTCP:LISTEN`
然后对对应 PID 执行 `kill <PID>`（必要时 `kill -9 <PID>`）。

## 启动（按顺序执行，分别开 4 个终端）
> 下面把局域网 IP 用 `<LAN_IP>` 代替；你可以用 `ipconfig getifaddr en0` 获取。

### 0) 统一加载环境 + 清理代理（每个终端都建议先执行）
```bash
set -a; source docker.env; set +a
unset ALL_PROXY all_proxy HTTP_PROXY http_proxy HTTPS_PROXY https_proxy
export NO_PROXY=localhost,127.0.0.1,<LAN_IP>
export no_proxy=$NO_PROXY
```

### 1) 启动 SurrealDB（端口 8001）
```bash
mkdir -p surreal_data
surreal start --log info --user root --pass root --bind 0.0.0.0:8001 \
  rocksdb:./surreal_data/mydatabase.db
```

### 2) 启动 API（端口 5055，对局域网开放）
```bash
export API_HOST=0.0.0.0
export API_PORT=5055
export SURREAL_URL=ws://localhost:8001/rpc
uv run run_api.py
```

### 3) 启动 Worker
```bash
export SURREAL_URL=ws://localhost:8001/rpc
uv run surreal-commands-worker --import-modules commands
```

### 4) 启动前端（端口 3000，对局域网开放）
```bash
cd frontend
npm run dev -- -H 0.0.0.0 -p 3000
```

## 验证
- API：`curl http://localhost:5055/health`
- 前端配置：`curl http://localhost:3000/config`（应返回 apiUrl，通常是 `http://<LAN_IP>:5055`）
- 同事访问：`http://<LAN_IP>:3000`

## 可选优化（你确认后我可以帮你改到“无需手动处理 IP/代理”）
- 把 `API_URL` 从固定 IP 改为自动探测（避免换 Wi‑Fi 后要改文件）。
- 新增一个一键脚本（例如 `scripts/restart-lan.sh`）把以上步骤封装起来，并加入端口检查/提示。