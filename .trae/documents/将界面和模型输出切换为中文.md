# 完整方案：前端界面中文化 + 可切换语言（zh-CN / en）+ 后端模型输出跟随语言

## 现状结论
- 前端未接入 i18n；大量 UI 文案硬编码英文；RootLayout `lang="en"` 写死。[layout.tsx](file:///Users/imac/Documents/open-notebook/frontend/src/app/layout.tsx#L18-L41)
- 后端所有 LLM 链路（Chat / Source Chat / Ask / Transformations / Podcast）目前都不读取 `Accept-Language`，也不把语言偏好注入 prompt，因此模型输出不会随语言变化。

## 目标与体验
- 支持 `zh-CN` 与 `en` 两套界面文案，提供即时切换并持久化（刷新仍保持）。
- 所有前端触发的模型输出（Chat、Source Chat、Ask、Transformations、Podcast）自动跟随当前语言：
  - 前端统一在请求头发送 `Accept-Language: zh-CN` 或 `en`
  - 后端从请求头解析 `output_language`，并在 prompt/system instruction 中强制输出目标语言。

## 一条链路的端到端数据流（语言）
1. 前端语言切换 → 写入 `localStorage` + Cookie（用于 SSR 的 `html lang`）
2. 前端每次 API 请求带 `Accept-Language`（axios 拦截器 + fetch/SSE 手动补齐）
3. 后端路由读取 header → 解析成标准值 `output_language`（`zh-CN|en`）与一段 `output_language_instruction`
4. 后端 graph / prompt 渲染时把 `output_language_instruction` 注入模板（或对 Transformation/Podcast 以“前置指令/briefing_suffix”拼接）

## 前端实现方案（不额外引入 i18n 依赖）
1. **语言状态（Zustand + 持久化）**
   - 新增 `useLanguageStore`（参考 [theme-store.ts](file:///Users/imac/Documents/open-notebook/frontend/src/lib/stores/theme-store.ts#L1-L61)）
   - `setLanguage()` 同步：zustand persist + `document.cookie=language=...` + `document.documentElement.lang=...`
2. **SSR 初始语言（RootLayout 读 Cookie）**
   - 修改 [layout.tsx](file:///Users/imac/Documents/open-notebook/frontend/src/app/layout.tsx#L18-L41)：用 `cookies()` 读取 `language` Cookie 动态设置 `<html lang={...}>`
3. **翻译字典与 t()**
   - 新增 `frontend/src/i18n/messages/{en,zh-CN}.ts`
   - 新增 `frontend/src/i18n/index.ts`：`t(key, params?)`、缺失 key 回退英文
4. **语言切换 UI**
   - 新增 `LanguageToggle`，放在侧边栏底部与 ThemeToggle 相邻。[AppSidebar.tsx](file:///Users/imac/Documents/open-notebook/frontend/src/components/layout/AppSidebar.tsx#L289-L355)
5. **界面文案迁移（全站）**
   - 把硬编码英文逐步替换为 `t('...')`：导航/通用组件 → 核心页面 → placeholder/tooltip/aria-label → toast（hooks）

## 前端：把语言带到后端（Accept-Language）
1. **axios 全局**
   - 在 [client.ts](file:///Users/imac/Documents/open-notebook/frontend/src/lib/api/client.ts#L18-L49) 的 request interceptor 中读取 `language-storage`，设置 `config.headers['Accept-Language']=...`
2. **fetch/SSE 补齐**（目前不走 axios）
   - Ask streaming：[search.ts](file:///Users/imac/Documents/open-notebook/frontend/src/lib/api/search.ts#L11-L61) 的 fetch headers 增加 `Accept-Language`
   - Source chat streaming：[source-chat.ts](file:///Users/imac/Documents/open-notebook/frontend/src/lib/api/source-chat.ts#L48-L84) 的 fetch headers 增加 `Accept-Language`

## 后端实现方案：解析 Accept-Language 并注入 prompt
1. **统一解析工具**
   - 新增一个小工具（例如 `open_notebook/utils/language_utils.py`）：
     - `parse_output_language(accept_language: str|None) -> Literal['zh-CN','en']`
     - `build_output_language_instruction(lang) -> str`（例如 `Respond in English.` / `Use Simplified Chinese (zh-CN).`）
2. **Chat（notebook chat）**
   - 在 [chat.py 路由](file:///Users/imac/Documents/open-notebook/api/routers/chat.py#L313-L363) 的 `execute_chat` 读取 `Accept-Language`（Header），把 `output_language_instruction` 写入 `state_values`，并让 graph 状态持久化。
   - 修改 [graphs/chat.py](file:///Users/imac/Documents/open-notebook/open_notebook/graphs/chat.py#L19-L33)：ThreadState 增加 `output_language_instruction`；模板渲染 `data=state` 即可带入。
   - 修改 prompt 模板 [chat/system.jinja](file:///Users/imac/Documents/open-notebook/prompts/chat/system.jinja)：新增一段“OUTPUT LANGUAGE”并输出 `{{output_language_instruction}}`。
3. **Source Chat（source_chat）**
   - 在 [source_chat.py 路由](file:///Users/imac/Documents/open-notebook/api/routers/source_chat.py#L388-L440) 的发送消息入口读取 header，并把语言传到 `stream_source_chat_response(...)` → graph input。
   - 修改 [graphs/source_chat.py](file:///Users/imac/Documents/open-notebook/open_notebook/graphs/source_chat.py#L104-L114)：把 `output_language_instruction` 放入 `prompt_data`，模板可读取。
   - 修改 prompt 模板 [source_chat/system.jinja](file:///Users/imac/Documents/open-notebook/prompts/source_chat/system.jinja)：同样插入 `{{output_language_instruction}}`。
4. **Ask（search/ask 与 ask/simple）**
   - 在 [search.py](file:///Users/imac/Documents/open-notebook/api/routers/search.py#L110-L214) 的两条 ask 入口读取 header，并把 `output_language_instruction` 传入 ask_graph 的 `input`（例如 `dict(question=..., output_language_instruction=...)`）。
   - 修改 [graphs/ask.py](file:///Users/imac/Documents/open-notebook/open_notebook/graphs/ask.py#L41-L71) 的 state type，使模板渲染时可访问该字段。
   - 修改 ask 的 3 个模板：[entry.jinja](file:///Users/imac/Documents/open-notebook/prompts/ask/entry.jinja)、[query_process.jinja](file:///Users/imac/Documents/open-notebook/prompts/ask/query_process.jinja)、[final_answer.jinja](file:///Users/imac/Documents/open-notebook/prompts/ask/final_answer.jinja) 加入“OUTPUT LANGUAGE”段落。
5. **Transformations（/transformations/execute）**
   - 在 [transformations.py](file:///Users/imac/Documents/open-notebook/api/routers/transformations.py#L81-L109) 的 execute 入口读取 header，并把 `output_language_instruction` 传给 transformation graph input。
   - 修改 [graphs/transformation.py](file:///Users/imac/Documents/open-notebook/open_notebook/graphs/transformation.py#L20-L45)：
     - 让 state 支持 `output_language_instruction`
     - 在构造 `transformation_template_text` 时：当 `transformation.apply_default` 为 true 时，把 `output_language_instruction` 作为最前置指令拼接（避免强制影响那些需要固定格式/语言的 transformation）。
     - 同时修复默认 prompt 没有从 DB 生效的问题（目前写死 `DefaultPrompts(transformation_instructions=None)`）。[transformation.py](file:///Users/imac/Documents/open-notebook/open_notebook/graphs/transformation.py#L28-L33)
6. **Podcasts（/podcasts/generate）**
   - 在 [podcasts.py](file:///Users/imac/Documents/open-notebook/api/routers/podcasts.py#L40-L63) 读取 header，把语言指令自动追加到 `briefing_suffix`（利用已有字段实现最小侵入），保证大纲与脚本按目标语言输出。

## 验证方式
- 前端：`npm run lint`、`npm run build`；手动验证语言切换与刷新保持。
- 后端：用最小请求验证 `Accept-Language: zh-CN` 时 Chat/Ask/SourceChat 输出中文；切回 `en` 输出英文。
- 回归：确认不带 header 时仍默认英文（不破坏旧客户端）。

## 交付物
- 前端：i18n 基建 + LanguageToggle + 全站文案替换 + API 请求头注入
- 后端：Accept-Language 解析工具 + 3 条 prompt 模板/graph 注入（chat/source_chat/ask）+ transformations/podcast 的语言注入
